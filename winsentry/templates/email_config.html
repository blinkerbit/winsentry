<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Configuration - WinSentry</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .nav-link.active { background-color: #007bff !important; color: white !important; }
        .card-header { background-color: #f8f9fa; }
        .template-preview { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem; }
        .btn-group-sm .btn { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; }
        .status-indicator.online { background-color: #28a745; }
        .status-indicator.offline { background-color: #dc3545; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt"></i> WinSentry
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Tabs -->
        <ul class="nav nav-tabs" id="emailTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="smtp-tab" data-bs-toggle="tab" data-bs-target="#smtp" type="button" role="tab">
                    <i class="fas fa-server"></i> SMTP Configuration
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates" type="button" role="tab">
                    <i class="fas fa-envelope"></i> Email Templates
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="port-config-tab" data-bs-toggle="tab" data-bs-target="#port-config" type="button" role="tab">
                    <i class="fas fa-cog"></i> Port Email Settings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="test-tab" data-bs-toggle="tab" data-bs-target="#test" type="button" role="tab">
                    <i class="fas fa-vial"></i> Test Email
                </button>
            </li>
        </ul>

        <div class="tab-content" id="emailTabsContent">
            <!-- SMTP Configuration Tab -->
            <div class="tab-pane fade show active" id="smtp" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-server"></i> SMTP Server Configuration</h5>
                            </div>
                            <div class="card-body">
                                <form id="smtpConfigForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="smtpServer" class="form-label">SMTP Server</label>
                                                <input type="text" class="form-control" id="smtpServer" placeholder="smtp.gmail.com" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="smtpPort" class="form-label">SMTP Port</label>
                                                <input type="number" class="form-control" id="smtpPort" value="587" min="1" max="65535" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="smtpUsername" class="form-label">Username</label>
                                                <input type="text" class="form-control" id="smtpUsername" placeholder="your-email@gmail.com" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="smtpPassword" class="form-label">Password</label>
                                                <input type="password" class="form-control" id="smtpPassword" placeholder="App Password" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="fromEmail" class="form-label">From Email</label>
                                                <input type="email" class="form-control" id="fromEmail" placeholder="alerts@yourcompany.com" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="fromName" class="form-label">From Name</label>
                                                <input type="text" class="form-control" id="fromName" value="WinSentry Alert System" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="useTls" checked>
                                            <label class="form-check-label" for="useTls">
                                                Use TLS/SSL
                                            </label>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Save Configuration
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" onclick="testSmtpConnection()">
                                            <i class="fas fa-vial"></i> Test Connection
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Templates Tab -->
            <div class="tab-pane fade" id="templates" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-envelope"></i> Email Templates</h5>
                                <button class="btn btn-sm btn-primary" onclick="showAddTemplateModal()">
                                    <i class="fas fa-plus"></i> Add Template
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Template Name</th>
                                                <th>Subject</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="templatesTable">
                                            <tr>
                                                <td colspan="3" class="text-center">
                                                    <i class="fas fa-spinner fa-spin"></i> Loading templates...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-eye"></i> Template Preview</h5>
                            </div>
                            <div class="card-body">
                                <div id="templatePreview" class="template-preview">
                                    <p class="text-muted">Select a template to preview</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Port Email Configuration Tab -->
            <div class="tab-pane fade" id="port-config" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-cog"></i> Port Email Configuration</h5>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-primary" onclick="showAddPortEmailConfigModal()">
                                        <i class="fas fa-plus"></i> Add Configuration
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="refreshPortEmailConfigs()">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Port</th>
                                                <th>Email Enabled</th>
                                                <th>Recipients</th>
                                                <th>Template</th>
                                                <th>Script Failures</th>
                                                <th>Email Failures</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="portEmailConfigsTable">
                                            <tr>
                                                <td colspan="7" class="text-center">
                                                    <i class="fas fa-spinner fa-spin"></i> Loading configurations...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Email Tab -->
            <div class="tab-pane fade" id="test" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-vial"></i> Test Email Configuration</h5>
                            </div>
                            <div class="card-body">
                                <form id="testEmailForm">
                                    <div class="mb-3">
                                        <label for="testRecipients" class="form-label">Test Recipients (comma-separated)</label>
                                        <input type="text" class="form-control" id="testRecipients" placeholder="admin@yourcompany.com, support@yourcompany.com" required>
                                        <div class="form-text">Enter email addresses separated by commas</div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-outline-primary" onclick="testSmtpConnection()">
                                            <i class="fas fa-plug"></i> Test SMTP Connection
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-paper-plane"></i> Send Test Email
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Template Modal -->
    <div class="modal fade" id="addTemplateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Email Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTemplateForm">
                        <div class="mb-3">
                            <label for="templateName" class="form-label">Template Name</label>
                            <input type="text" class="form-control" id="templateName" required>
                        </div>
                        <div class="mb-3">
                            <label for="templateSubject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="templateSubject" required>
                            <div class="form-text">Use variables: {port}, {status}, {failure_count}, {timestamp}, {server_name}</div>
                        </div>
                        <div class="mb-3">
                            <label for="templateBody" class="form-label">Email Body</label>
                            <textarea class="form-control" id="templateBody" rows="10" required></textarea>
                            <div class="form-text">Use variables: {port}, {status}, {failure_count}, {timestamp}, {server_name}, {message}</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTemplate()">Save Template</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Port Email Config Modal -->
    <div class="modal fade" id="portEmailConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Configure Port Email Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="portEmailConfigForm">
                        <div class="mb-3" id="portSelectionDiv">
                            <label for="configPort" class="form-label">Port</label>
                            <select class="form-control" id="configPort" required>
                                <option value="">Select a port...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="emailEnabled">
                                <label class="form-check-label" for="emailEnabled">
                                    Enable email alerts for this port
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="emailRecipients" class="form-label">Recipients (comma-separated)</label>
                            <input type="text" class="form-control" id="emailRecipients" placeholder="admin@company.com, support@company.com">
                        </div>
                        <div class="mb-3">
                            <label for="emailTemplate" class="form-label">Email Template</label>
                            <select class="form-control" id="emailTemplate">
                                <option value="default">Default Template</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="scriptFailures" class="form-label">PowerShell Script Failures</label>
                                    <input type="number" class="form-control" id="scriptFailures" value="3" min="1" max="100">
                                    <div class="form-text">Execute script after N failures</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="emailFailures" class="form-label">Email Alert Failures</label>
                                    <input type="number" class="form-control" id="emailFailures" value="5" min="1" max="100">
                                    <div class="form-text">Send email after M failures</div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePortEmailConfig()">Save Configuration</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentTemplates = {};
        let currentPortEmailConfigs = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadSmtpConfig();
            loadTemplates();
            loadPortEmailConfigs();
            populateTemplateDropdown();
        });

        // SMTP Configuration Functions
        async function loadSmtpConfig() {
            try {
                const response = await fetch('/api/email/config');
                const data = await response.json();
                
                if (data.success) {
                    const config = data.smtp_config;
                    document.getElementById('smtpServer').value = config.smtp_server || '';
                    document.getElementById('smtpPort').value = config.smtp_port || 587;
                    document.getElementById('smtpUsername').value = config.smtp_username || '';
                    document.getElementById('smtpPassword').value = config.smtp_password || '';
                    document.getElementById('fromEmail').value = config.from_email || '';
                    document.getElementById('fromName').value = config.from_name || 'WinSentry Alert System';
                    document.getElementById('useTls').checked = config.use_tls !== false;
                }
            } catch (error) {
                showAlert('Error loading SMTP configuration: ' + error.message, 'danger');
            }
        }

        document.getElementById('smtpConfigForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const config = {
                smtp_server: document.getElementById('smtpServer').value,
                smtp_port: parseInt(document.getElementById('smtpPort').value),
                smtp_username: document.getElementById('smtpUsername').value,
                smtp_password: document.getElementById('smtpPassword').value,
                from_email: document.getElementById('fromEmail').value,
                from_name: document.getElementById('fromName').value,
                use_tls: document.getElementById('useTls').checked
            };
            
            try {
                const response = await fetch('/api/email/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                showAlert(data.message, data.success ? 'success' : 'danger');
            } catch (error) {
                showAlert('Error saving SMTP configuration: ' + error.message, 'danger');
            }
        });

        async function testSmtpConnection() {
            try {
                const response = await fetch('/api/email/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'connection' })
                });
                
                const data = await response.json();
                showAlert(data.message || data.error, data.success ? 'success' : 'danger');
            } catch (error) {
                showAlert('Error testing SMTP connection: ' + error.message, 'danger');
            }
        }

        // Template Functions
        async function loadTemplates() {
            try {
                const response = await fetch('/api/email/templates');
                const data = await response.json();
                
                if (data.success) {
                    currentTemplates = data.templates;
                    displayTemplates();
                }
            } catch (error) {
                showAlert('Error loading templates: ' + error.message, 'danger');
            }
        }

        function displayTemplates() {
            const tbody = document.getElementById('templatesTable');
            tbody.innerHTML = '';
            
            Object.keys(currentTemplates).forEach(templateName => {
                const template = currentTemplates[templateName];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${templateName}</strong></td>
                    <td>${template.subject}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="previewTemplate('${templateName}')">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteTemplate('${templateName}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update template dropdown
            populateTemplateDropdown();
        }

        function populateTemplateDropdown() {
            const dropdown = document.getElementById('emailTemplate');
            dropdown.innerHTML = '';
            
            Object.keys(currentTemplates).forEach(templateName => {
                const option = document.createElement('option');
                option.value = templateName;
                option.textContent = templateName;
                dropdown.appendChild(option);
            });
        }

        function showAddTemplateModal() {
            document.getElementById('addTemplateForm').reset();
            new bootstrap.Modal(document.getElementById('addTemplateModal')).show();
        }

        async function saveTemplate() {
            const templateName = document.getElementById('templateName').value;
            const subject = document.getElementById('templateSubject').value;
            const body = document.getElementById('templateBody').value;
            
            try {
                const response = await fetch('/api/email/templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ template_name: templateName, subject, body })
                });
                
                const data = await response.json();
                showAlert(data.message, data.success ? 'success' : 'danger');
                
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('addTemplateModal')).hide();
                    loadTemplates();
                }
            } catch (error) {
                showAlert('Error saving template: ' + error.message, 'danger');
            }
        }

        function previewTemplate(templateName) {
            const template = currentTemplates[templateName];
            const preview = document.getElementById('templatePreview');
            
            const sampleData = {
                port: 8080,
                status: 'OFFLINE',
                failure_count: 3,
                timestamp: new Date().toLocaleString(),
                server_name: 'Test Server',
                message: 'Port has been offline for 3 consecutive checks'
            };
            
            const subject = template.subject.replace(/\{(\w+)\}/g, (match, key) => sampleData[key] || match);
            const body = template.body.replace(/\{(\w+)\}/g, (match, key) => sampleData[key] || match);
            
            preview.innerHTML = `
                <h6><strong>Subject:</strong> ${subject}</h6>
                <hr>
                <h6><strong>Body:</strong></h6>
                <pre style="white-space: pre-wrap; font-family: inherit;">${body}</pre>
            `;
        }

        async function deleteTemplate(templateName) {
            if (!confirm(`Delete template "${templateName}"?`)) return;
            
            try {
                const response = await fetch('/api/email/templates', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ template_name: templateName })
                });
                
                const data = await response.json();
                showAlert(data.message, data.success ? 'success' : 'danger');
                
                if (data.success) {
                    loadTemplates();
                }
            } catch (error) {
                showAlert('Error deleting template: ' + error.message, 'danger');
            }
        }

        // Port Email Configuration Functions
        async function loadPortEmailConfigs() {
            try {
                const response = await fetch('/api/email/port-config');
                const data = await response.json();
                
                if (data.success) {
                    currentPortEmailConfigs = data.configs;
                    displayPortEmailConfigs();
                } else {
                    showAlert('Error loading port email configurations: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Error loading port email configurations: ' + error.message, 'danger');
            }
        }

        function displayPortEmailConfigs() {
            const tbody = document.getElementById('portEmailConfigsTable');
            tbody.innerHTML = '';
            
            if (currentPortEmailConfigs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No port email configurations found</td></tr>';
                return;
            }
            
            currentPortEmailConfigs.forEach(config => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${config.port} (${config.port_name || 'Unknown'})</td>
                    <td>
                        <span class="badge ${config.enabled ? 'bg-success' : 'bg-secondary'}">
                            ${config.enabled ? 'Enabled' : 'Disabled'}
                        </span>
                    </td>
                    <td>${config.recipients ? config.recipients.join(', ') : 'None'}</td>
                    <td>${config.template || 'default'}</td>
                    <td>${config.powershell_script_failures || 3}</td>
                    <td>${config.email_alert_failures || 5}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="editPortEmailConfig(${config.port})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deletePortEmailConfig(${config.port})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function refreshPortEmailConfigs() {
            loadPortEmailConfigs();
        }

        function showAddPortEmailConfigModal() {
            // Reset form
            document.getElementById('portEmailConfigForm').reset();
            
            // Populate port dropdown
            populatePortDropdown();
            
            // Show port selection
            document.getElementById('portSelectionDiv').style.display = 'block';
            
            // Show modal
            new bootstrap.Modal(document.getElementById('portEmailConfigModal')).show();
        }

        function populatePortDropdown() {
            const dropdown = document.getElementById('configPort');
            dropdown.innerHTML = '<option value="">Select a port...</option>';
            
            // Get monitored ports from the current configurations
            if (currentPortEmailConfigs && currentPortEmailConfigs.length > 0) {
                currentPortEmailConfigs.forEach(config => {
                    const option = document.createElement('option');
                    option.value = config.port;
                    option.textContent = `${config.port} (${config.port_name || 'Unknown'})`;
                    dropdown.appendChild(option);
                });
            }
        }

        function editPortEmailConfig(port) {
            const config = currentPortEmailConfigs.find(c => c.port === port);
            if (!config) return;
            
            // Hide port selection for editing
            document.getElementById('portSelectionDiv').style.display = 'none';
            
            // Populate the modal
            document.getElementById('configPort').value = port;
            document.getElementById('emailEnabled').checked = config.enabled || false;
            document.getElementById('emailRecipients').value = config.recipients ? config.recipients.join(', ') : '';
            document.getElementById('emailTemplate').value = config.template || 'default';
            document.getElementById('scriptFailures').value = config.powershell_script_failures || 3;
            document.getElementById('emailFailures').value = config.email_alert_failures || 5;
            
            // Show the modal
            new bootstrap.Modal(document.getElementById('portEmailConfigModal')).show();
        }

        async function savePortEmailConfig() {
            const port = parseInt(document.getElementById('configPort').value);
            const config = {
                enabled: document.getElementById('emailEnabled').checked,
                recipients: document.getElementById('emailRecipients').value.split(',').map(email => email.trim()).filter(email => email),
                template: document.getElementById('emailTemplate').value,
                powershell_script_failures: parseInt(document.getElementById('scriptFailures').value),
                email_alert_failures: parseInt(document.getElementById('emailFailures').value)
            };
            
            try {
                const response = await fetch('/api/email/port-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port, config })
                });
                
                const data = await response.json();
                showAlert(data.message, data.success ? 'success' : 'danger');
                
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('portEmailConfigModal')).hide();
                    loadPortEmailConfigs();
                }
            } catch (error) {
                showAlert('Error saving port email configuration: ' + error.message, 'danger');
            }
        }

        async function deletePortEmailConfig(port) {
            if (!confirm(`Delete email configuration for port ${port}?`)) return;
            
            try {
                const response = await fetch('/api/email/port-config', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port })
                });
                
                const data = await response.json();
                showAlert(data.message, data.success ? 'success' : 'danger');
                
                if (data.success) {
                    loadPortEmailConfigs();
                }
            } catch (error) {
                showAlert('Error deleting port email configuration: ' + error.message, 'danger');
            }
        }

        // Test Email Functions
        document.getElementById('testEmailForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const recipients = document.getElementById('testRecipients').value.split(',').map(email => email.trim());
            
            try {
                const response = await fetch('/api/email/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'email', recipients })
                });
                
                const data = await response.json();
                showAlert(data.message, data.success ? 'success' : 'danger');
            } catch (error) {
                showAlert('Error sending test email: ' + error.message, 'danger');
            }
        });

        // Utility Functions
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
