<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WinSentry - Windows Service & Port Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #1e293b;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            color: #64748b;
            font-size: 16px;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: #3b82f6;
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #f1f5f9;
            color: #334155;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 16px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .form-checkbox {
            margin-right: 8px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .table tbody tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-online {
            background: #dcfce7;
            color: #166534;
        }

        .status-offline {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-running {
            background: #dcfce7;
            color: #166534;
        }

        .status-stopped {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-normal {
            background: #dcfce7;
            color: #166534;
        }

        .text-red-600 {
            color: #dc2626;
        }

        .text-gray-500 {
            color: #6b7280;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s;
        }

        .progress-fill.warning {
            background: #f59e0b;
        }

        .progress-fill.critical {
            background: #ef4444;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }

        .modal-close:hover {
            color: #334155;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #64748b;
            font-size: 14px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mb-0 {
            margin-bottom: 0;
        }

        .mb-1 {
            margin-bottom: 8px;
        }

        .mb-2 {
            margin-bottom: 16px;
        }

        .mb-3 {
            margin-bottom: 24px;
        }

        .mb-4 {
            margin-bottom: 32px;
        }

        .mt-0 {
            margin-top: 0;
        }

        .mt-1 {
            margin-top: 8px;
        }

        .mt-2 {
            margin-top: 16px;
        }

        .mt-3 {
            margin-top: 24px;
        }

        .mt-4 {
            margin-top: 32px;
        }

        .flex {
            display: flex;
        }

        .flex-wrap {
            flex-wrap: wrap;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 8px;
        }

        .gap-3 {
            gap: 12px;
        }

        .w-full {
            width: 100%;
        }

        .grid {
            display: grid;
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-cols-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                margin-bottom: 4px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .grid-cols-2,
            .grid-cols-3,
            .grid-cols-4 {
                grid-template-columns: 1fr;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #1e293b;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #64748b;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .modal-close:hover {
            background: #f1f5f9;
            color: #334155;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .port-link {
            color: #3b82f6;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .port-link:hover {
            color: #1d4ed8;
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="flex justify-between items-center">
                <div>
                    <h1>WinSentry</h1>
                    <p>Windows Service & Port Monitoring Dashboard</p>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-secondary" onclick="viewAllServices()" title="View all Windows services">
                        <span>üîß</span> View All Services
                    </button>
                    <button class="btn btn-info" onclick="openEmailConfig()"
                        title="Configure email settings and templates">
                        <span>üìß</span> Email Config
                    </button>
                    <button class="btn btn-primary" onclick="refreshAllData()" title="Refresh all monitoring data">
                        <span>üîÑ</span> Refresh All
                    </button>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="port-monitor">Port Monitor</button>
            <button class="nav-tab" data-tab="service-monitor">Service Monitor</button>
            <button class="nav-tab" data-tab="resource-monitor">Resource Monitor</button>
            <button class="nav-tab" data-tab="adhoc-checks">Adhoc Checks</button>
            <button class="nav-tab" data-tab="logs">Logs</button>
        </div>

        <!-- Port Monitor Tab -->
        <div id="port-monitor" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Add Port Monitor</h2>
                </div>
                <form id="portMonitorForm">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-group">
                            <label class="form-label" for="portNumber">Port Number</label>
                            <input type="number" id="portNumber" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="portInterval">Check Interval (seconds)</label>
                            <input type="number" id="portInterval" class="form-input" value="30" min="5">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="portScriptPath">Recovery Script Path (.ps1 file)</label>
                        <input type="text" id="portScriptPath" class="form-input"
                            placeholder="Optional path to .ps1 script file (e.g., C:\scripts\restart.ps1)">
                        <small class="text-gray-500">If provided, this script file will be used instead of inline
                            commands</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="portScript">Recovery Commands (PowerShell)</label>
                        <textarea id="portScript" class="form-input" rows="3"
                            placeholder="Optional inline PowerShell commands to run when port goes offline"></textarea>
                        <small class="text-gray-500">Used only if no script path is provided above</small>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-group">
                            <label class="form-label" for="portRecoveryDelay">Recovery Script Delay (seconds)</label>
                            <input type="number" id="portRecoveryDelay" class="form-input" value="20" min="5">
                            <small class="text-gray-500">Minimum time between recovery script executions (default:
                                20s)</small>
                        </div>
                        <div class="form-group" style="display: flex; align-items: center; padding-top: 20px;">
                            <label>
                                <input type="checkbox" id="portEnabled" class="form-checkbox" checked>
                                Enable monitoring
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Port Monitor</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="flex justify-between items-center">
                        <h2 class="card-title">Monitored Ports</h2>
                        <button class="btn btn-secondary btn-sm" onclick="refreshPortMonitors()"
                            title="Refresh port status">
                            <span>üîÑ</span> Refresh
                        </button>
                    </div>
                </div>
                <div id="portStats" class="stats-grid"></div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Port</th>
                                <th>Status</th>
                                <th>Uptime</th>
                                <th>Last Checked</th>
                                <th>Success Rate</th>
                                <th>Interval</th>
                                <th>Failures</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="portTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Service Monitor Tab -->
        <div id="service-monitor" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Add Service Monitor</h2>
                </div>
                <form id="serviceMonitorForm">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-group">
                            <label class="form-label" for="serviceName">Service Name</label>
                            <input type="text" id="serviceName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="serviceInterval">Check Interval (seconds)</label>
                            <input type="number" id="serviceInterval" class="form-input" value="30" min="5">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="serviceScript">Recovery Script (PowerShell)</label>
                        <textarea id="serviceScript" class="form-input" rows="3"
                            placeholder="Optional PowerShell script to run when service stops"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="serviceRecoveryDelay">Recovery Script Delay (seconds)</label>
                        <input type="number" id="serviceRecoveryDelay" class="form-input" value="20" min="5">
                        <small class="text-gray-500">Minimum time between recovery script executions (default:
                            20s)</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="serviceEmailRecipients">Email Recipients
                            (comma-separated)</label>
                        <input type="text" id="serviceEmailRecipients" class="form-input"
                            placeholder="admin@example.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Auto-Restart Configuration:</label>
                        <div class="grid grid-cols-3 gap-2">
                            <label>
                                <input type="checkbox" id="autoRestartEnabled" class="form-checkbox" checked>
                                Auto-restart if stopped
                            </label>
                            <div class="form-group">
                                <label class="form-label" for="maxRestartAttempts">Max Retries</label>
                                <input type="number" id="maxRestartAttempts" class="form-input" value="3" min="1"
                                    max="10">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="restartDelay">Delay (seconds)</label>
                                <input type="number" id="restartDelay" class="form-input" value="5" min="1" max="60">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Send Alert When:</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label>
                                <input type="checkbox" id="alertOnStopped" class="form-checkbox" checked>
                                Service Stopped
                            </label>
                            <label>
                                <input type="checkbox" id="alertOnStarted" class="form-checkbox">
                                Service Started
                            </label>
                            <label>
                                <input type="checkbox" id="alertOnRestartSuccess" class="form-checkbox" checked>
                                Restart Successful
                            </label>
                            <label>
                                <input type="checkbox" id="alertOnRestartFailed" class="form-checkbox" checked>
                                Restart Failed
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="serviceEnabled" class="form-checkbox" checked>
                            Enable monitoring
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Service Monitor</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="flex justify-between items-center">
                        <h2 class="card-title">Monitored Services</h2>
                        <button class="btn btn-secondary btn-sm" onclick="refreshServiceMonitors()"
                            title="Refresh service status">
                            <span>üîÑ</span> Refresh
                        </button>
                    </div>
                </div>
                <div id="serviceStats" class="stats-grid"></div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Status</th>
                                <th>Last Checked</th>
                                <th>Interval</th>
                                <th>Failures</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="serviceTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Resource Monitor Tab -->
        <div id="resource-monitor" class="tab-content">
            <!-- Live System Resources Card -->
            <div class="card">
                <div class="card-header">
                    <div class="flex justify-between items-center">
                        <h2 class="card-title">üñ•Ô∏è Live System Resources</h2>
                        <button class="btn btn-secondary btn-sm" onclick="refreshSystemResources()"
                            title="Refresh resources">
                            <span>üîÑ</span> Refresh
                        </button>
                    </div>
                </div>
                <div id="liveResourcesDisplay" class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">CPU Usage</div>
                        <div class="stat-value" id="liveCpuUsage">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">RAM Usage</div>
                        <div class="stat-value" id="liveRamUsage">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">RAM (Used/Total)</div>
                        <div class="stat-value" id="liveRamDetails">--</div>
                    </div>
                </div>
                <div class="table-responsive" style="margin-top: 15px;">
                    <h4 style="margin-bottom: 10px;">üíæ Disk Usage</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Drive</th>
                                <th>Used</th>
                                <th>Free</th>
                                <th>Total</th>
                                <th>Usage %</th>
                            </tr>
                        </thead>
                        <tbody id="diskUsageTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Configure Thresholds Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">‚öôÔ∏è Configure Resource Thresholds</h2>
                </div>
                <form id="resourceThresholdForm">
                    <div class="grid grid-cols-3 gap-3">
                        <div class="form-group">
                            <label class="form-label" for="resourceType">Resource Type</label>
                            <select id="resourceType" class="form-input" required onchange="toggleDriveSelect()">
                                <option value="cpu">CPU Usage</option>
                                <option value="ram">RAM Usage</option>
                                <option value="disk">Disk Space</option>
                            </select>
                        </div>
                        <div class="form-group" id="driveSelectGroup" style="display: none;">
                            <label class="form-label" for="driveLetter">Drive Letter</label>
                            <select id="driveLetter" class="form-input">
                                <option value="C:">C:</option>
                                <option value="D:">D:</option>
                                <option value="E:">E:</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="thresholdPercent">Threshold (%)</label>
                            <input type="number" id="thresholdPercent" class="form-input" min="1" max="100" value="80"
                                required>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-group">
                            <label class="form-label" for="checkInterval">Check Interval (seconds)</label>
                            <input type="number" id="checkInterval" class="form-input" min="10" max="3600" value="60">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="alertRecipients">Email Recipients (comma-separated)</label>
                            <input type="text" id="alertRecipients" class="form-input" placeholder="admin@example.com">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableThresholdAlerts" class="form-checkbox" checked>
                            Enable email alerts when threshold exceeded
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">Set Threshold</button>
                </form>
            </div>

            <!-- Configured Thresholds Card -->
            <div class="card">
                <div class="card-header">
                    <div class="flex justify-between items-center">
                        <h2 class="card-title">üìä Configured Thresholds</h2>
                        <button class="btn btn-secondary btn-sm" onclick="refreshResourceThresholds()"
                            title="Refresh thresholds">
                            <span>üîÑ</span> Refresh
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Resource</th>
                                <th>Threshold</th>
                                <th>Current Value</th>
                                <th>Status</th>
                                <th>Check Interval</th>
                                <th>Email Alerts</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="thresholdsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Adhoc Checks Tab -->
        <div id="adhoc-checks" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Create Adhoc Check</h2>
                </div>
                <form id="adhocCheckForm">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-group">
                            <label class="form-label" for="adhocCheckType">Check Type</label>
                            <select id="adhocCheckType" class="form-input" onchange="toggleAdhocCheckFields()">
                                <option value="service">Windows Service</option>
                                <option value="process">Running Process</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="adhocTargetName">Target Name</label>
                            <input type="text" id="adhocTargetName" class="form-input" required
                                placeholder="Service name or process name (e.g., Spooler, notepad.exe)">
                        </div>
                    </div>

                    <div class="form-group" id="adhocExpectedStateGroup">
                        <label class="form-label" for="adhocExpectedState">Expected State</label>
                        <select id="adhocExpectedState" class="form-input">
                            <option value="running">Running</option>
                            <option value="stopped">Stopped</option>
                            <option value="any">Any (just report status)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">If Check Fails (state mismatch):</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label>
                                <input type="checkbox" id="adhocActionStartService" class="form-checkbox">
                                Start Service (if stopped)
                            </label>
                            <label>
                                <input type="checkbox" id="adhocActionStopService" class="form-checkbox">
                                Stop Service (if running)
                            </label>
                            <label>
                                <input type="checkbox" id="adhocActionRunScript" class="form-checkbox">
                                Run PowerShell Script
                            </label>
                            <label>
                                <input type="checkbox" id="adhocActionSendEmail" class="form-checkbox" checked>
                                Send Email Alert
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="adhocScriptGroup" style="display:none;">
                        <label class="form-label" for="adhocPowershellScript">PowerShell Script</label>
                        <textarea id="adhocPowershellScript" class="form-input" rows="3"
                            placeholder="PowerShell commands to run if check fails"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="adhocEmailRecipients">Email Recipients (comma-separated)</label>
                        <input type="text" id="adhocEmailRecipients" class="form-input" placeholder="admin@example.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Schedule:</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label>
                                <input type="radio" name="adhocScheduleType" value="now" checked
                                    onchange="toggleScheduleFields()">
                                Run Now (once)
                            </label>
                            <label>
                                <input type="radio" name="adhocScheduleType" value="scheduled"
                                    onchange="toggleScheduleFields()">
                                Scheduled / Recurring
                            </label>
                        </div>
                    </div>

                    <div id="adhocScheduleFields" style="display:none;">
                        <div class="grid grid-cols-3 gap-3">
                            <div class="form-group">
                                <label class="form-label" for="adhocScheduleDay">Day of Week</label>
                                <select id="adhocScheduleDay" class="form-input">
                                    <option value="*">Every Day</option>
                                    <option value="0">Sunday</option>
                                    <option value="1">Monday</option>
                                    <option value="2">Tuesday</option>
                                    <option value="3">Wednesday</option>
                                    <option value="4">Thursday</option>
                                    <option value="5">Friday</option>
                                    <option value="6">Saturday</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="adhocScheduleTime">Time</label>
                                <input type="time" id="adhocScheduleTime" class="form-input" value="14:00">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="adhocCheckName">Check Name</label>
                                <input type="text" id="adhocCheckName" class="form-input"
                                    placeholder="Weekly Service Check">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <button type="submit" class="btn btn-primary">Run / Schedule Check</button>
                        <button type="button" class="btn btn-secondary" onclick="runAdhocCheckNow()">‚ñ∂ Run Now</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="flex justify-between items-center">
                        <h2 class="card-title">Scheduled Checks</h2>
                        <button class="btn btn-secondary btn-sm" onclick="refreshScheduledChecks()" title="Refresh">
                            <span>üîÑ</span> Refresh
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Target</th>
                                <th>Schedule</th>
                                <th>Last Run</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="scheduledChecksTableBody">
                            <tr>
                                <td colspan="7" class="text-center text-muted">No scheduled checks configured</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Check Results</h2>
                </div>
                <div id="adhocCheckResults" class="log-container">
                    <p class="text-muted">Run a check to see results here...</p>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="logs" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="flex justify-between items-center">
                        <h2 class="card-title">System Logs</h2>
                        <button class="btn btn-secondary btn-sm" onclick="refreshLogs()" title="Refresh logs">
                            <span>üîÑ</span> Refresh
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="logFilter">Filter Logs</label>
                    <select id="logFilter" class="form-select">
                        <option value="all">All Logs</option>
                        <option value="port">Port Monitor</option>
                        <option value="service">Service Monitor</option>
                        <option value="resource">Resource Monitor</option>
                    </select>
                </div>
                <div id="logsContainer"
                    style="max-height: 500px; overflow-y: auto; background: #f8fafc; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 12px;">
                </div>
            </div>
        </div>
    </div>

    <!-- Process Details Modal -->
    <div id="processModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Process Details</h3>
                <button class="modal-close" onclick="hideModal('processModal')">&times;</button>
            </div>
            <div id="processDetails">
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.getAttribute('data-tab');

                // Remove active class from all tabs and content
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modal when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    hideModal(modal.id);
                }
            });
        });

        // API helper functions
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                showAlert('error', `API Error: ${error.message}`);
                throw error;
            }
        }

        // Time formatting helper function - returns formatted timestamp
        function getTimeDelta(timestamp) {
            if (!timestamp) return 'Never';

            try {
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) return 'Invalid Date';

                // Format as YYYY-MM-DD HH:MM:SS in local time
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');

                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } catch (error) {
                return 'Invalid Date';
            }
        }

        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;

            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Port Monitor Functions
        document.getElementById('portMonitorForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                port: parseInt(document.getElementById('portNumber').value),
                interval: parseInt(document.getElementById('portInterval').value),
                powershell_script: document.getElementById('portScriptPath').value.trim() || null,
                powershell_commands: document.getElementById('portScript').value.trim() || null,
                recovery_script_delay: parseInt(document.getElementById('portRecoveryDelay').value) || 20,
                enabled: document.getElementById('portEnabled').checked
            };

            try {
                await apiCall('/api/ports/config', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                showAlert('success', 'Port monitor added successfully');
                document.getElementById('portMonitorForm').reset();
                refreshPortMonitors();
            } catch (error) {
                showAlert('error', 'Failed to add port monitor');
            }
        });

        async function refreshPortMonitors() {
            try {
                const response = await apiCall('/api/ports');
                const ports = response.ports || [];
                displayPortMonitors(ports);
                updatePortStats(ports);
            } catch (error) {
                console.error('Failed to refresh port monitors:', error);
                showAlert('error', 'Failed to refresh port monitors');
            }
        }

        async function checkPortNow(port) {
            try {
                const response = await apiCall('/api/ports/check-now', {
                    method: 'POST',
                    body: JSON.stringify({ port: port })
                });

                if (response.success) {
                    showAlert('success', response.message);
                    refreshPortMonitors();
                } else {
                    showAlert('error', response.error || 'Failed to check port');
                }
            } catch (error) {
                showAlert('error', 'Failed to check port: ' + error.message);
            }
        }

        function displayPortMonitors(ports) {
            const tbody = document.getElementById('portTableBody');
            tbody.innerHTML = '';

            ports.forEach(port => {
                const row = document.createElement('tr');

                // Format success rate
                const successRate = port.success_rate ? `${port.success_rate.toFixed(1)}%` : 'N/A';

                // Format uptime
                const uptime = port.uptime_display || (port.uptime_seconds > 0 ? `${port.uptime_seconds}s` : '-');

                // Status badge with enhanced styling
                const statusClass = port.status === 'online' ? 'status-online' : 'status-offline';
                const statusText = port.status === 'online' ? 'ONLINE' : 'OFFLINE';

                row.innerHTML = `
                    <td><strong><a href="#" onclick="openPortInNewTab(${port.port}); return false;" class="port-link" title="Click to open port details in new tab">${port.port}</a></strong></td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td><span title="Uptime since last status change">${uptime}</span></td>
                    <td><span title="${port.last_check || 'Never checked'}">${getTimeDelta(port.last_check)}</span></td>
                    <td><span title="Success rate over ${port.total_checks || 0} total checks">${successRate}</span></td>
                    <td>${port.interval}s</td>
                    <td><span class="${port.failure_count > 0 ? 'text-red-600' : ''}">${port.failure_count || 0}</span></td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="checkPortNow(${port.port})" title="Check status immediately">Check</button>
                        <button class="btn btn-sm btn-primary" onclick="viewPortDetails(${port.port})" title="View detailed information">Details</button>
                        <button class="btn btn-sm btn-info" onclick="editPortConfig(${port.port})" title="Edit port configuration">Edit</button>
                        <button class="btn btn-sm btn-warning" onclick="killProcessesOnPort(${port.port})" title="Kill processes on this port">Kill</button>
                        <button class="btn btn-sm btn-danger" onclick="forceKillProcessesOnPort(${port.port})" title="Force kill processes on this port">Force Kill</button>
                        <button class="btn btn-sm btn-secondary" onclick="removePortMonitor(${port.port})" title="Remove monitoring">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updatePortStats(ports) {
            const stats = {
                total: ports.length,
                online: ports.filter(p => p.status === 'online').length,
                offline: ports.filter(p => p.status === 'offline').length,
                totalChecks: ports.reduce((sum, p) => sum + (p.total_checks || 0), 0),
                avgSuccessRate: ports.length > 0 ? ports.reduce((sum, p) => sum + (p.success_rate || 0), 0) / ports.length : 0
            };

            document.getElementById('portStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Total Ports</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.online}</div>
                    <div class="stat-label">Online</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.offline}</div>
                    <div class="stat-label">Offline</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.totalChecks}</div>
                    <div class="stat-label">Total Checks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.avgSuccessRate.toFixed(1)}%</div>
                    <div class="stat-label">Avg Success Rate</div>
                </div>
            `;
        }

        async function viewPortDetails(port) {
            try {
                // Get detailed port information
                const response = await apiCall(`/api/ports/processes?port=${port}`);
                const processes = response.processes || [];

                // Get port logs
                const logsResponse = await apiCall(`/api/logs?port=${port}`);
                const logs = logsResponse.logs || [];

                // Get port configuration
                const portsResponse = await apiCall('/api/ports');
                const ports = portsResponse.ports || [];
                const portConfig = ports.find(p => p.port === port);

                let detailsHtml = `
                    <h4>Port ${port} Details</h4>
                    <div class="mb-3">
                        <strong>Processes on Port:</strong> ${processes.length}
                    </div>
                `;

                // Add recovery script information
                if (portConfig) {
                    detailsHtml += `
                        <div class="mb-3">
                            <strong>Recovery Configuration:</strong>
                    `;

                    if (portConfig.powershell_script) {
                        detailsHtml += `
                            <div class="mt-1">
                                <strong>Script File:</strong> <code>${portConfig.powershell_script}</code>
                            </div>
                        `;
                    } else if (portConfig.powershell_commands) {
                        detailsHtml += `
                            <div class="mt-1">
                                <strong>Inline Commands:</strong>
                                <pre style="background: #f8fafc; padding: 8px; border-radius: 4px; font-size: 12px; margin-top: 4px;">${portConfig.powershell_commands}</pre>
                            </div>
                        `;
                    } else {
                        detailsHtml += `
                            <div class="mt-1 text-gray-500">No recovery script configured</div>
                        `;
                    }

                    detailsHtml += `</div>`;
                }

                if (processes.length > 0) {
                    detailsHtml += `
                        <h5 class="mt-3">Running Processes</h5>
                        <div style="max-height: 300px; overflow-y: auto;">
                    `;

                    processes.forEach(proc => {
                        detailsHtml += `
                            <div class="mb-2 p-2" style="background: #f8fafc; border-radius: 4px;">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div><strong>PID:</strong> ${proc.pid}</div>
                                        <div><strong>Name:</strong> ${proc.name}</div>
                                        <div><strong>Status:</strong> ${proc.status}</div>
                                        <div><strong>CPU:</strong> ${proc.cpu_percent.toFixed(1)}%</div>
                                        <div><strong>Memory:</strong> ${proc.memory_percent.toFixed(1)}%</div>
                                        <div><strong>User:</strong> ${proc.username}</div>
                                        <div><strong>Command:</strong> ${proc.cmdline ? proc.cmdline.join(' ') : 'N/A'}</div>
                                    </div>
                                    <div class="ml-2">
                                        <button class="btn btn-xs btn-warning" onclick="killProcess(${proc.pid})" title="Kill process">Kill</button>
                                        <button class="btn btn-xs btn-danger" onclick="forceKillProcess(${proc.pid})" title="Force kill process">Force Kill</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    detailsHtml += '</div>';
                } else {
                    detailsHtml += '<p class="text-gray-500">No processes currently running on this port.</p>';
                }

                // Add recent logs
                if (logs.length > 0) {
                    detailsHtml += `
                        <h5 class="mt-3">Recent Logs</h5>
                        <div style="max-height: 200px; overflow-y: auto; background: #f8fafc; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">
                    `;

                    logs.slice(0, 10).forEach(log => {
                        detailsHtml += `
                            <div style="margin-bottom: 4px; padding: 2px;">
                                <span style="color: #64748b;">[${getTimeDelta(log.timestamp)}]</span>
                                <span style="color: ${log.level === 'ERROR' ? '#dc2626' : log.level === 'WARNING' ? '#d97706' : '#2563eb'}; font-weight: bold;">${log.level}</span>
                                <span>${log.message}</span>
                            </div>
                        `;
                    });

                    detailsHtml += '</div>';
                }

                document.getElementById('processDetails').innerHTML = detailsHtml;
                showModal('processModal');
            } catch (error) {
                showAlert('error', 'Failed to load port details');
            }
        }

        async function removePortMonitor(port) {
            if (confirm(`Remove monitoring for port ${port}?`)) {
                try {
                    await apiCall(`/api/ports/config?port=${port}`, {
                        method: 'DELETE'
                    });
                    showAlert('success', 'Port monitor removed');
                    refreshPortMonitors();
                } catch (error) {
                    showAlert('error', 'Failed to remove port monitor');
                }
            }
        }

        async function killProcessesOnPort(port) {
            if (confirm(`Are you sure you want to kill all processes on port ${port}?`)) {
                try {
                    const response = await apiCall('/api/ports/kill', {
                        method: 'POST',
                        body: JSON.stringify({ port: port })
                    });

                    if (response.success) {
                        const result = response.result;
                        let message = `Killed ${result.killed_processes.length} processes on port ${port}`;
                        if (result.failed_processes.length > 0) {
                            message += ` (${result.failed_processes.length} failed)`;
                        }
                        showAlert('success', message);
                        refreshPortMonitors();
                    } else {
                        showAlert('error', 'Failed to kill processes on port');
                    }
                } catch (error) {
                    showAlert('error', 'Failed to kill processes on port');
                }
            }
        }

        async function forceKillProcessesOnPort(port) {
            if (confirm(`Are you sure you want to FORCE KILL all processes on port ${port}? This action cannot be undone!`)) {
                try {
                    const response = await apiCall('/api/ports/force-kill', {
                        method: 'POST',
                        body: JSON.stringify({ port: port })
                    });

                    if (response.success) {
                        const result = response.result;
                        let message = `Force killed ${result.killed_processes.length} processes on port ${port}`;
                        if (result.failed_processes.length > 0) {
                            message += ` (${result.failed_processes.length} failed)`;
                        }
                        showAlert('success', message);
                        refreshPortMonitors();
                    } else {
                        showAlert('error', 'Failed to force kill processes on port');
                    }
                } catch (error) {
                    showAlert('error', 'Failed to force kill processes on port');
                }
            }
        }

        async function killProcess(pid) {
            if (confirm(`Are you sure you want to kill process ${pid}?`)) {
                try {
                    const response = await apiCall('/api/ports/kill-process', {
                        method: 'POST',
                        body: JSON.stringify({ pid: pid })
                    });

                    if (response.success) {
                        showAlert('success', `Process ${pid} killed successfully`);
                        // Refresh the port details if modal is open
                        const modal = document.getElementById('portDetailsModal');
                        if (modal && modal.style.display !== 'none') {
                            const port = modal.getAttribute('data-port');
                            if (port) {
                                viewPortDetails(parseInt(port));
                            }
                        }
                    } else {
                        showAlert('error', 'Failed to kill process');
                    }
                } catch (error) {
                    showAlert('error', 'Failed to kill process');
                }
            }
        }

        async function forceKillProcess(pid) {
            if (confirm(`Are you sure you want to FORCE KILL process ${pid}? This action cannot be undone!`)) {
                try {
                    const response = await apiCall('/api/ports/force-kill-process', {
                        method: 'POST',
                        body: JSON.stringify({ pid: pid })
                    });

                    if (response.success) {
                        showAlert('success', `Process ${pid} force killed successfully`);
                        // Refresh the port details if modal is open
                        const modal = document.getElementById('portDetailsModal');
                        if (modal && modal.style.display !== 'none') {
                            const port = modal.getAttribute('data-port');
                            if (port) {
                                viewPortDetails(parseInt(port));
                            }
                        }
                    } else {
                        showAlert('error', 'Failed to force kill process');
                    }
                } catch (error) {
                    showAlert('error', 'Failed to force kill process');
                }
            }
        }

        async function editPortConfig(port) {
            try {
                // Get current port configuration from database
                const response = await apiCall(`/api/ports/config?port=${port}`);

                if (!response.success) {
                    showAlert('error', 'Port configuration not found');
                    return;
                }

                const portConfig = response.config;

                // Create edit modal
                const modalHtml = `
                    <div id="editPortModal" class="modal-overlay" style="display: flex;">
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">
                                <h3>Edit Port ${port} Configuration</h3>
                                <button class="modal-close" onclick="closeEditPortModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="editPortForm">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label" for="editPortNumber">Port Number</label>
                                            <input type="number" id="editPortNumber" class="form-input" value="${port}" readonly>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="editPortInterval">Check Interval (seconds)</label>
                                            <input type="number" id="editPortInterval" class="form-input" value="${portConfig.interval}" min="5" max="3600">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="editPortScriptPath">Recovery Script Path (.ps1 file)</label>
                                        <input type="text" id="editPortScriptPath" class="form-input" value="${portConfig.powershell_script || ''}" placeholder="Optional path to .ps1 script file">
                                        <small class="text-gray-500">If provided, this script file will be used instead of inline commands</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="editPortScript">Recovery Commands (PowerShell)</label>
                                        <textarea id="editPortScript" class="form-input" rows="3" placeholder="Optional inline PowerShell commands">${portConfig.powershell_commands || ''}</textarea>
                                        <small class="text-gray-500">Used only if no script path is provided above</small>
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="editPortEnabled" class="form-checkbox" ${portConfig.enabled ? 'checked' : ''}>
                                            Enable monitoring
                                        </label>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeEditPortModal()">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="savePortConfig()">Save Changes</button>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal if any
                const existingModal = document.getElementById('editPortModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHtml);

            } catch (error) {
                showAlert('error', 'Failed to load port configuration');
            }
        }

        function closeEditPortModal() {
            const modal = document.getElementById('editPortModal');
            if (modal) {
                modal.remove();
            }
        }

        async function savePortConfig() {
            try {
                const port = parseInt(document.getElementById('editPortNumber').value);
                const interval = parseInt(document.getElementById('editPortInterval').value);
                const powershell_script = document.getElementById('editPortScriptPath').value.trim() || null;
                const powershell_commands = document.getElementById('editPortScript').value.trim() || null;
                const enabled = document.getElementById('editPortEnabled').checked;

                const formData = {
                    port: port,
                    interval: interval,
                    powershell_script: powershell_script,
                    powershell_commands: powershell_commands,
                    enabled: enabled
                };

                const response = await apiCall('/api/ports/config', {
                    method: 'PUT',
                    body: JSON.stringify(formData)
                });

                if (response.success) {
                    showAlert('success', response.message);
                    closeEditPortModal();
                    refreshPortMonitors();
                } else {
                    showAlert('error', response.message || 'Failed to update port configuration');
                }

            } catch (error) {
                showAlert('error', 'Failed to update port configuration');
            }
        }

        async function viewAllServices() {
            try {
                // Get all services from the API
                const response = await apiCall('/api/services');

                if (!response.success) {
                    showAlert('error', 'Failed to load services');
                    return;
                }

                const services = response.services || [];

                // Create services modal
                const modalHtml = `
                    <div id="allServicesModal" class="modal-overlay" style="display: flex;">
                        <div class="modal-content" style="max-width: 1200px; max-height: 80vh;">
                            <div class="modal-header">
                                <h3>All Windows Services (${services.length} total)</h3>
                                <button class="modal-close" onclick="closeAllServicesModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <input type="text" id="serviceSearch" class="form-input" placeholder="Search services..." onkeyup="filterServices()">
                                </div>
                                <div style="max-height: 500px; overflow-y: auto;">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Service Name</th>
                                                <th>Display Name</th>
                                                <th>State</th>
                                                <th>Status</th>
                                                <th>Start Mode</th>
                                                <th>PID</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="servicesTableBody">
                                            ${services.map(service => `
                                                <tr class="service-row" data-name="${service.name}">
                                                    <td><strong>${service.name}</strong></td>
                                                    <td>${service.display_name || 'N/A'}</td>
                                                    <td>
                                                        <span class="status-badge ${service.state === 'Running' ? 'status-online' : 'status-offline'}">
                                                            ${service.state || 'Unknown'}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="status-badge ${service.status === 'OK' ? 'status-online' : 'status-offline'}">
                                                            ${service.status || 'Unknown'}
                                                        </span>
                                                    </td>
                                                    <td>${service.start_mode || 'N/A'}</td>
                                                    <td>${service.process_id || 'N/A'}</td>
                                                    <td>
                                                        <div class="flex gap-1">
                                                            ${service.state === 'Running' ?
                        `<button class="btn btn-xs btn-warning" onclick="performServiceAction('${service.name}', 'stop')" title="Stop service">Stop</button>` :
                        `<button class="btn btn-xs btn-success" onclick="performServiceAction('${service.name}', 'start')" title="Start service">Start</button>`
                    }
                                                            <button class="btn btn-xs btn-info" onclick="performServiceAction('${service.name}', 'restart')" title="Restart service">Restart</button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeAllServicesModal()">Close</button>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal if any
                const existingModal = document.getElementById('allServicesModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHtml);

            } catch (error) {
                showAlert('error', 'Failed to load services');
            }
        }

        function closeAllServicesModal() {
            const modal = document.getElementById('allServicesModal');
            if (modal) {
                modal.remove();
            }
        }

        function filterServices() {
            const searchTerm = document.getElementById('serviceSearch').value.toLowerCase();
            const rows = document.querySelectorAll('.service-row');

            rows.forEach(row => {
                const serviceName = row.getAttribute('data-name').toLowerCase();
                const displayName = row.cells[1].textContent.toLowerCase();
                const state = row.cells[2].textContent.toLowerCase();
                const status = row.cells[3].textContent.toLowerCase();
                const startMode = row.cells[4].textContent.toLowerCase();

                if (serviceName.includes(searchTerm) ||
                    displayName.includes(searchTerm) ||
                    state.includes(searchTerm) ||
                    status.includes(searchTerm) ||
                    startMode.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        async function performServiceAction(serviceName, action) {
            if (confirm(`Are you sure you want to ${action} the service "${serviceName}"?`)) {
                try {
                    const response = await apiCall(`/api/services/${encodeURIComponent(serviceName)}/${action}`, {
                        method: 'POST'
                    });

                    if (response.success) {
                        showAlert('success', response.message);
                        // Refresh the services list
                        viewAllServices();
                    } else {
                        showAlert('error', response.message || `Failed to ${action} service`);
                    }
                } catch (error) {
                    showAlert('error', `Failed to ${action} service`);
                }
            }
        }

        function openEmailConfig() {
            // Open email configuration page in a new tab
            window.open('/email-config', '_blank');
        }

        function openPortInNewTab(port) {
            // Open port details in a new tab
            const newWindow = window.open('', '_blank');
            if (newWindow) {
                // Create a simple HTML page for the port details
                newWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>Port ${port} Details - WinSentry</title>
                        <style>
                            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 20px; background: #f8fafc; }
                            .container { max-width: 1200px; margin: 0 auto; }
                            .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
                            .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
                            .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin: 4px; text-decoration: none; display: inline-block; }
                            .btn-primary { background: #3b82f6; color: white; }
                            .btn-secondary { background: #6b7280; color: white; }
                            .btn-warning { background: #f59e0b; color: white; }
                            .btn-danger { background: #ef4444; color: white; }
                            .btn-info { background: #06b6d4; color: white; }
                            .btn:hover { opacity: 0.9; }
                            .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
                            .status-online { background: #dcfce7; color: #166534; }
                            .status-offline { background: #fecaca; color: #991b1b; }
                            .table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                            .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
                            .table th { background: #f9fafb; font-weight: 600; }
                            .loading { text-align: center; padding: 40px; color: #6b7280; }
                            .error { color: #ef4444; background: #fef2f2; padding: 12px; border-radius: 4px; margin: 10px 0; }
                            .success { color: #166534; background: #f0fdf4; padding: 12px; border-radius: 4px; margin: 10px 0; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <div class="header">
                                <h1>Port ${port} Details - WinSentry</h1>
                                <p>Real-time monitoring and management for port ${port}</p>
                                <div>
                                    <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh</button>
                                    <button class="btn btn-secondary" onclick="window.close()">‚úï Close</button>
                                </div>
                            </div>
                            <div id="content">
                                <div class="loading">Loading port details...</div>
                            </div>
                        </div>
                        <script>
                            let refreshInterval;
                            
                            async function apiCall(url, options = {}) {
                                try {
                                    const response = await fetch(url, {
                                        headers: { 'Content-Type': 'application/json' },
                                        ...options
                                    });
                                    return await response.json();
                                } catch (error) {
                                    console.error('API call failed:', error);
                                    return { success: false, error: error.message };
                                }
                            }
                            
                            async function refreshData() {
                                try {
                                    // Get port processes
                                    const processesResponse = await apiCall(\`/api/ports/processes?port=${port}\`);
                                    const processes = processesResponse.processes || [];
                                    
                                    // Get port logs
                                    const logsResponse = await apiCall(\`/api/logs?port=${port}\`);
                                    const logs = logsResponse.logs || [];
                                    
                                    // Get port configuration
                                    const portsResponse = await apiCall('/api/ports');
                                    const ports = portsResponse.ports || [];
                                    const portConfig = ports.find(p => p.port === ${port});
                                    
                                    let content = \`
                                        <div class="card">
                                            <h3>Port Status & Configuration</h3>
                                            <table class="table">
                                                <tr><th>Port</th><td><strong>${port}</strong></td></tr>
                                                <tr><th>Status</th><td><span class="status-badge \${portConfig?.status === 'online' ? 'status-online' : 'status-offline'}">\${portConfig?.status?.toUpperCase() || 'UNKNOWN'}</span></td></tr>
                                                <tr><th>Check Interval</th><td>\${portConfig?.interval || 'N/A'} seconds</td></tr>
                                                <tr><th>Failure Count</th><td>\${portConfig?.failure_count || 0}</td></tr>
                                                <tr><th>Last Checked</th><td>\${portConfig?.last_check || 'Never'}</td></tr>
                                                <tr><th>Success Rate</th><td>\${portConfig?.success_rate ? portConfig.success_rate.toFixed(1) + '%' : 'N/A'}</td></tr>
                                            </table>
                                        </div>
                                        
                                        <div class="card">
                                            <h3>Recovery Configuration</h3>
                                    \`;
                                    
                                    if (portConfig?.powershell_script) {
                                        content += \`
                                            <p><strong>Script File:</strong> <code>\${portConfig.powershell_script}</code></p>
                                        \`;
                                    } else if (portConfig?.powershell_commands) {
                                        content += \`
                                            <p><strong>Inline Commands:</strong></p>
                                            <pre style="background: #f8fafc; padding: 12px; border-radius: 4px; overflow-x: auto;">\${portConfig.powershell_commands}</pre>
                                        \`;
                                    } else {
                                        content += \`<p class="text-gray-500">No recovery script configured</p>\`;
                                    }
                                    
                                    content += \`</div>\`;
                                    
                                    if (processes.length > 0) {
                                        content += \`
                                            <div class="card">
                                                <h3>Processes on Port ${port} (\${processes.length})</h3>
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>PID</th>
                                                            <th>Name</th>
                                                            <th>Status</th>
                                                            <th>CPU %</th>
                                                            <th>Memory %</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                        \`;
                                        
                                        processes.forEach(process => {
                                            content += \`
                                                <tr>
                                                    <td>\${process.pid}</td>
                                                    <td>\${process.name}</td>
                                                    <td>\${process.status}</td>
                                                    <td>\${process.cpu_percent}%</td>
                                                    <td>\${process.memory_percent}%</td>
                                                    <td>
                                                        <button class="btn btn-warning btn-sm" onclick="killProcess(\${process.pid})">Kill</button>
                                                        <button class="btn btn-danger btn-sm" onclick="forceKillProcess(\${process.pid})">Force Kill</button>
                                                    </td>
                                                </tr>
                                            \`;
                                        });
                                        
                                        content += \`
                                                    </tbody>
                                                </table>
                                            </div>
                                        \`;
                                    } else {
                                        content += \`
                                            <div class="card">
                                                <h3>Processes on Port ${port}</h3>
                                                <p>No processes currently running on this port.</p>
                                            </div>
                                        \`;
                                    }
                                    
                                    if (logs.length > 0) {
                                        content += \`
                                            <div class="card">
                                                <h3>Recent Logs (Last 10)</h3>
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>Timestamp</th>
                                                            <th>Status</th>
                                                            <th>Message</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                        \`;
                                        
                                        logs.slice(0, 10).forEach(log => {
                                            content += \`
                                                <tr>
                                                    <td>\${new Date(log.timestamp).toLocaleString()}</td>
                                                    <td><span class="status-badge \${log.status === 'online' ? 'status-online' : 'status-offline'}">\${log.status?.toUpperCase() || 'UNKNOWN'}</span></td>
                                                    <td>\${log.message || 'No message'}</td>
                                                </tr>
                                            \`;
                                        });
                                        
                                        content += \`
                                                    </tbody>
                                                </table>
                                            </div>
                                        \`;
                                    }
                                    
                                    document.getElementById('content').innerHTML = content;
                                    
                                } catch (error) {
                                    document.getElementById('content').innerHTML = \`
                                        <div class="error">Failed to load port details: \${error.message}</div>
                                    \`;
                                }
                            }
                            
                            async function killProcess(pid) {
                                if (confirm(\`Kill process \${pid}?\`)) {
                                    const response = await apiCall(\`/api/ports/kill-process\`, {
                                        method: 'POST',
                                        body: JSON.stringify({ pid })
                                    });
                                    
                                    if (response.success) {
                                        alert('Process killed successfully');
                                        refreshData();
                                    } else {
                                        alert('Failed to kill process: ' + response.error);
                                    }
                                }
                            }
                            
                            async function forceKillProcess(pid) {
                                if (confirm(\`Force kill process \${pid}?\`)) {
                                    const response = await apiCall(\`/api/ports/force-kill-process\`, {
                                        method: 'POST',
                                        body: JSON.stringify({ pid })
                                    });
                                    
                                    if (response.success) {
                                        alert('Process force killed successfully');
                                        refreshData();
                                    } else {
                                        alert('Failed to force kill process: ' + response.error);
                                    }
                                }
                            }
                            
                            // Auto-refresh every 30 seconds
                            refreshInterval = setInterval(refreshData, 30000);
                            
                            // Initial load
                            refreshData();
                            
                            // Clean up on window close
                            window.addEventListener('beforeunload', () => {
                                if (refreshInterval) {
                                    clearInterval(refreshInterval);
                                }
                            });
                        <\/script>
                    <\/body>
                    <\/html>
                `);
                newWindow.document.close();
            }
        }

        // Adhoc Checks Functions
        function toggleAdhocCheckFields() {
            const checkType = document.getElementById('adhocCheckType').value;
            const expectedStateGroup = document.getElementById('adhocExpectedStateGroup');
            const startServiceCheckbox = document.getElementById('adhocActionStartService');
            const stopServiceCheckbox = document.getElementById('adhocActionStopService');

            if (checkType === 'process') {
                // For processes, simplified options
                startServiceCheckbox.parentElement.style.display = 'none';
                stopServiceCheckbox.parentElement.style.display = 'none';
            } else {
                startServiceCheckbox.parentElement.style.display = '';
                stopServiceCheckbox.parentElement.style.display = '';
            }
        }

        function toggleScheduleFields() {
            const scheduleType = document.querySelector('input[name="adhocScheduleType"]:checked').value;
            const scheduleFields = document.getElementById('adhocScheduleFields');
            scheduleFields.style.display = scheduleType === 'scheduled' ? 'block' : 'none';
        }

        // Toggle script field visibility
        document.getElementById('adhocActionRunScript').addEventListener('change', function () {
            document.getElementById('adhocScriptGroup').style.display = this.checked ? 'block' : 'none';
        });

        async function runAdhocCheckNow() {
            const checkType = document.getElementById('adhocCheckType').value;
            const targetName = document.getElementById('adhocTargetName').value;
            const expectedState = document.getElementById('adhocExpectedState').value;

            if (!targetName) {
                showAlert('error', 'Please enter a target name');
                return;
            }

            const formData = {
                check_type: checkType,
                target_name: targetName,
                expected_state: expectedState,
                actions: {
                    start_service: document.getElementById('adhocActionStartService').checked,
                    stop_service: document.getElementById('adhocActionStopService').checked,
                    run_script: document.getElementById('adhocActionRunScript').checked,
                    send_email: document.getElementById('adhocActionSendEmail').checked
                },
                powershell_script: document.getElementById('adhocPowershellScript').value,
                email_recipients: document.getElementById('adhocEmailRecipients').value
            };

            try {
                const response = await apiCall('/api/adhoc-check/run', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                displayAdhocResult(response);
                showAlert('success', 'Check completed');
            } catch (error) {
                showAlert('error', 'Failed to run check: ' + error.message);
            }
        }

        document.getElementById('adhocCheckForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const scheduleType = document.querySelector('input[name="adhocScheduleType"]:checked').value;

            if (scheduleType === 'now') {
                await runAdhocCheckNow();
            } else {
                await scheduleAdhocCheck();
            }
        });

        async function scheduleAdhocCheck() {
            const checkType = document.getElementById('adhocCheckType').value;
            const targetName = document.getElementById('adhocTargetName').value;
            const expectedState = document.getElementById('adhocExpectedState').value;
            const checkName = document.getElementById('adhocCheckName').value || `${checkType}-${targetName}`;
            const scheduleDay = document.getElementById('adhocScheduleDay').value;
            const scheduleTime = document.getElementById('adhocScheduleTime').value;

            if (!targetName) {
                showAlert('error', 'Please enter a target name');
                return;
            }

            const formData = {
                name: checkName,
                check_type: checkType,
                target_name: targetName,
                expected_state: expectedState,
                schedule: {
                    day_of_week: scheduleDay,
                    time: scheduleTime
                },
                actions: {
                    start_service: document.getElementById('adhocActionStartService').checked,
                    stop_service: document.getElementById('adhocActionStopService').checked,
                    run_script: document.getElementById('adhocActionRunScript').checked,
                    send_email: document.getElementById('adhocActionSendEmail').checked
                },
                powershell_script: document.getElementById('adhocPowershellScript').value,
                email_recipients: document.getElementById('adhocEmailRecipients').value
            };

            try {
                await apiCall('/api/adhoc-check/schedule', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                showAlert('success', 'Check scheduled successfully');
                document.getElementById('adhocCheckForm').reset();
                refreshScheduledChecks();
            } catch (error) {
                showAlert('error', 'Failed to schedule check: ' + error.message);
            }
        }

        async function refreshScheduledChecks() {
            try {
                const response = await apiCall('/api/adhoc-check/scheduled');
                const checks = response.checks || [];
                displayScheduledChecks(checks);
            } catch (error) {
                console.error('Failed to refresh scheduled checks:', error);
            }
        }

        function displayScheduledChecks(checks) {
            const tbody = document.getElementById('scheduledChecksTableBody');

            if (checks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No scheduled checks configured</td></tr>';
                return;
            }

            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

            tbody.innerHTML = checks.map(check => {
                const dayDisplay = check.schedule.day_of_week === '*' ? 'Every Day' :
                    dayNames[parseInt(check.schedule.day_of_week)] || check.schedule.day_of_week;
                const scheduleDisplay = `${dayDisplay} at ${check.schedule.time}`;
                const statusClass = check.last_status === 'pass' ? 'running' : check.last_status === 'fail' ? 'stopped' : 'unknown';

                return `
                    <tr>
                        <td>${check.name}</td>
                        <td>${check.check_type}</td>
                        <td>${check.target_name}</td>
                        <td>${scheduleDisplay}</td>
                        <td>${getTimeDelta(check.last_run)}</td>
                        <td><span class="status-badge status-${statusClass}">${check.last_status || 'pending'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="runScheduledCheckNow('${check.id}')">‚ñ∂ Run</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteScheduledCheck('${check.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function displayAdhocResult(result) {
            const container = document.getElementById('adhocCheckResults');
            const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19);
            const statusClass = result.status === 'pass' ? 'success' : result.status === 'fail' ? 'error' : 'warning';

            const resultHtml = `
                <div class="log-entry log-${statusClass}">
                    <strong>[${timestamp}]</strong> 
                    <span class="status-badge status-${result.status === 'pass' ? 'running' : 'stopped'}">${result.status.toUpperCase()}</span>
                    <strong>${result.check_type}</strong>: ${result.target_name}<br>
                    <span>Current State: <strong>${result.current_state}</strong></span>
                    ${result.expected_state !== 'any' ? ` | Expected: <strong>${result.expected_state}</strong>` : ''}
                    ${result.actions_taken && result.actions_taken.length > 0 ?
                    `<br><span>Actions: ${result.actions_taken.join(', ')}</span>` : ''}
                    ${result.message ? `<br><span class="text-muted">${result.message}</span>` : ''}
                </div>
            ` + container.innerHTML;

            container.innerHTML = resultHtml;
        }

        async function runScheduledCheckNow(checkId) {
            try {
                const response = await apiCall(`/api/adhoc-check/scheduled/${checkId}/run`, {
                    method: 'POST'
                });
                displayAdhocResult(response);
                showAlert('success', 'Check executed');
                refreshScheduledChecks();
            } catch (error) {
                showAlert('error', 'Failed to run check: ' + error.message);
            }
        }

        async function deleteScheduledCheck(checkId) {
            if (!confirm('Are you sure you want to delete this scheduled check?')) return;

            try {
                await apiCall(`/api/adhoc-check/scheduled/${checkId}`, {
                    method: 'DELETE'
                });
                showAlert('success', 'Scheduled check deleted');
                refreshScheduledChecks();
            } catch (error) {
                showAlert('error', 'Failed to delete check: ' + error.message);
            }
        }

        // Service Monitor Functions
        document.getElementById('serviceMonitorForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                service_name: document.getElementById('serviceName').value,
                interval: parseInt(document.getElementById('serviceInterval').value),
                recovery_script: document.getElementById('serviceScript').value,
                recovery_script_delay: parseInt(document.getElementById('serviceRecoveryDelay').value) || 20,
                enabled: document.getElementById('serviceEnabled').checked,
                email_recipients: document.getElementById('serviceEmailRecipients').value,
                // Auto-restart configuration
                auto_restart_enabled: document.getElementById('autoRestartEnabled').checked,
                max_restart_attempts: parseInt(document.getElementById('maxRestartAttempts').value),
                restart_delay: parseInt(document.getElementById('restartDelay').value),
                // Alert configuration
                alert_on_stopped: document.getElementById('alertOnStopped').checked,
                alert_on_started: document.getElementById('alertOnStarted').checked,
                alert_on_restart_success: document.getElementById('alertOnRestartSuccess').checked,
                alert_on_restart_failed: document.getElementById('alertOnRestartFailed').checked
            };

            try {
                await apiCall('/api/service-monitor/config', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                showAlert('success', 'Service monitor added successfully');
                document.getElementById('serviceMonitorForm').reset();
                // Reset checkbox and field defaults
                document.getElementById('autoRestartEnabled').checked = true;
                document.getElementById('maxRestartAttempts').value = '3';
                document.getElementById('restartDelay').value = '5';
                document.getElementById('serviceRecoveryDelay').value = '20';
                document.getElementById('alertOnStopped').checked = true;
                document.getElementById('alertOnRestartSuccess').checked = true;
                document.getElementById('alertOnRestartFailed').checked = true;
                document.getElementById('serviceEnabled').checked = true;
                refreshServiceMonitors();
            } catch (error) {
                showAlert('error', 'Failed to add service monitor');
            }
        });

        async function refreshServiceMonitors() {
            try {
                const response = await apiCall('/api/service-monitor');
                const services = response.services || [];
                displayServiceMonitors(services);
                updateServiceStats(services);
            } catch (error) {
                console.error('Failed to refresh service monitors:', error);
                showAlert('error', 'Failed to refresh service monitors');
            }
        }

        function displayServiceMonitors(services) {
            const tbody = document.getElementById('serviceTableBody');
            tbody.innerHTML = '';

            services.forEach(service => {
                // Use the status string from API (running, stopped, paused, unknown, not_found)
                const statusText = service.status || 'unknown';
                const statusClass = statusText === 'running' ? 'running' : 'stopped';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${service.service_name}</td>
                    <td><span class="status-badge status-${statusClass}">${statusText}</span></td>
                    <td>${getTimeDelta(service.last_check)}</td>
                    <td>${service.interval}s</td>
                    <td>${service.failure_count || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="checkServiceNow('${service.service_name}')" title="Check status immediately">Check</button>
                        <button class="btn btn-sm btn-danger" onclick="removeServiceMonitor('${service.service_name}')">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateServiceStats(services) {
            const stats = {
                total: services.length,
                running: services.filter(s => s.status === 'running').length,
                stopped: services.filter(s => s.status !== 'running').length
            };

            document.getElementById('serviceStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Total Services</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.running}</div>
                    <div class="stat-label">Running</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.stopped}</div>
                    <div class="stat-label">Stopped</div>
                </div>
            `;
        }

        async function removeServiceMonitor(serviceName) {
            if (confirm(`Remove monitoring for service ${serviceName}?`)) {
                try {
                    await apiCall(`/api/service-monitor/config?service_name=${serviceName}`, {
                        method: 'DELETE'
                    });
                    showAlert('success', 'Service monitor removed');
                    refreshServiceMonitors();
                } catch (error) {
                    showAlert('error', 'Failed to remove service monitor');
                }
            }
        }

        async function checkServiceNow(serviceName) {
            try {
                const response = await apiCall('/api/service-monitor/check-now', {
                    method: 'POST',
                    body: JSON.stringify({ service_name: serviceName })
                });

                if (response.success) {
                    showAlert('success', response.message);
                    refreshServiceMonitors();
                } else {
                    showAlert('error', response.error || 'Failed to check service');
                }
            } catch (error) {
                showAlert('error', 'Failed to check service: ' + error.message);
            }
        }

        // ============== SYSTEM RESOURCE MONITOR FUNCTIONS ==============

        // Toggle drive letter dropdown when disk is selected
        function toggleDriveSelect() {
            const resourceType = document.getElementById('resourceType').value;
            const driveGroup = document.getElementById('driveSelectGroup');
            driveGroup.style.display = resourceType === 'disk' ? 'block' : 'none';
        }

        // Fetch and display live system resources
        async function refreshSystemResources() {
            try {
                const response = await apiCall('/api/system-resources');
                const resources = response.resources || response;

                // Update CPU
                const cpuPercent = resources.cpu?.percent || 0;
                document.getElementById('liveCpuUsage').innerHTML = `
                    <span style="font-size: 2rem; color: ${cpuPercent > 80 ? '#ef4444' : cpuPercent > 60 ? '#f59e0b' : '#10b981'}">${cpuPercent.toFixed(1)}%</span>
                `;

                // Update RAM
                const ram = resources.ram || {};
                const ramPercent = ram.percent || 0;
                document.getElementById('liveRamUsage').innerHTML = `
                    <span style="font-size: 2rem; color: ${ramPercent > 80 ? '#ef4444' : ramPercent > 60 ? '#f59e0b' : '#10b981'}">${ramPercent.toFixed(1)}%</span>
                `;
                document.getElementById('liveRamDetails').innerHTML = `
                    <span style="font-size: 1rem;">${ram.used_gb || 0} GB / ${ram.total_gb || 0} GB</span>
                `;

                // Update Disk Usage Table
                const diskTbody = document.getElementById('diskUsageTableBody');
                diskTbody.innerHTML = '';

                const disks = resources.disks || [];
                disks.forEach(disk => {
                    const row = document.createElement('tr');
                    const usageColor = disk.percent > 90 ? '#ef4444' : disk.percent > 75 ? '#f59e0b' : '#10b981';
                    row.innerHTML = `
                        <td><strong>${disk.drive}</strong></td>
                        <td>${disk.used_gb} GB</td>
                        <td>${disk.free_gb} GB</td>
                        <td>${disk.total_gb} GB</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${disk.percent}%; background: ${usageColor}"></div>
                            </div>
                            <small>${disk.percent.toFixed(1)}%</small>
                        </td>
                    `;
                    diskTbody.appendChild(row);
                });

                if (disks.length === 0) {
                    diskTbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No disk information available</td></tr>';
                }

            } catch (error) {
                console.error('Failed to refresh system resources:', error);
            }
        }

        // Form submission for adding new threshold
        document.getElementById('resourceThresholdForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const resourceType = document.getElementById('resourceType').value;
            const formData = {
                resource_type: resourceType,
                threshold_percent: parseFloat(document.getElementById('thresholdPercent').value),
                check_interval: parseInt(document.getElementById('checkInterval').value),
                email_alerts_enabled: document.getElementById('enableThresholdAlerts').checked,
                email_recipients: document.getElementById('alertRecipients').value
            };

            // Add drive letter for disk thresholds
            if (resourceType === 'disk') {
                formData.drive_letter = document.getElementById('driveLetter').value;
            }

            try {
                await apiCall('/api/system-resources/thresholds', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                showAlert('success', 'Resource threshold configured successfully');
                document.getElementById('resourceThresholdForm').reset();
                refreshResourceThresholds();
                refreshSystemResources();
            } catch (error) {
                showAlert('error', 'Failed to configure resource threshold');
            }
        });

        // Fetch and display configured thresholds
        async function refreshResourceThresholds() {
            try {
                const response = await apiCall('/api/system-resources/thresholds');
                const thresholds = response.thresholds || [];
                displayResourceThresholds(thresholds);
            } catch (error) {
                console.error('Failed to refresh resource thresholds:', error);
            }
        }

        function displayResourceThresholds(thresholds) {
            const tbody = document.getElementById('thresholdsTableBody');
            tbody.innerHTML = '';

            if (thresholds.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No thresholds configured. Add one above.</td></tr>';
                return;
            }

            thresholds.forEach(threshold => {
                const resourceName = threshold.resource_type === 'disk'
                    ? `Disk (${threshold.drive_letter})`
                    : threshold.resource_type.toUpperCase();

                const currentValue = threshold.last_value || 0;
                const status = currentValue >= threshold.threshold_percent ? 'critical' :
                    currentValue >= threshold.threshold_percent * 0.8 ? 'warning' : 'normal';

                const statusColors = {
                    'normal': '#10b981',
                    'warning': '#f59e0b',
                    'critical': '#ef4444'
                };

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${resourceName}</strong></td>
                    <td>${threshold.threshold_percent}%</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(currentValue, 100)}%; background: ${statusColors[status]}"></div>
                        </div>
                        <small>${currentValue.toFixed(1)}%</small>
                    </td>
                    <td><span class="status-badge status-${status}">${status.toUpperCase()}</span></td>
                    <td>${threshold.check_interval}s</td>
                    <td>${threshold.email_alerts_enabled ? '‚úÖ Enabled' : '‚ùå Disabled'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeResourceThreshold('${threshold.resource_type}', '${threshold.drive_letter || ''}')">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function removeResourceThreshold(resourceType, driveLetter) {
            const resourceName = resourceType === 'disk' ? `Disk (${driveLetter})` : resourceType.toUpperCase();
            if (confirm(`Remove threshold for ${resourceName}?`)) {
                try {
                    let url = `/api/system-resources/thresholds?resource_type=${resourceType}`;
                    if (driveLetter) {
                        url += `&drive_letter=${encodeURIComponent(driveLetter)}`;
                    }
                    await apiCall(url, { method: 'DELETE' });
                    showAlert('success', 'Threshold removed');
                    refreshResourceThresholds();
                } catch (error) {
                    showAlert('error', 'Failed to remove threshold');
                }
            }
        }

        // Legacy function redirects (for backward compatibility)
        async function refreshResourceMonitoring() {
            await refreshSystemResources();
            await refreshResourceThresholds();
        }

        // Logs Functions
        async function refreshLogs() {
            try {
                const filter = document.getElementById('logFilter').value;
                let allLogs = [];

                // Fetch logs based on filter
                if (filter === 'all' || filter === 'port') {
                    try {
                        const portResponse = await apiCall('/api/logs');
                        const portLogs = (portResponse.logs || []).map(log => ({
                            ...log,
                            source: 'port'
                        }));
                        allLogs = allLogs.concat(portLogs);
                    } catch (e) { console.log('Port logs not available'); }
                }

                if (filter === 'all' || filter === 'service') {
                    try {
                        const serviceResponse = await apiCall('/api/service-process-logs');
                        const serviceLogs = (serviceResponse.logs || []).map(log => ({
                            ...log,
                            source: 'service',
                            message: log.message || `Service ${log.service_name}: ${log.status}`,
                            level: log.status === 'STOPPED' || log.status === 'RESTART_FAILED' ? 'ERROR' :
                                log.status === 'RESTARTING' ? 'WARNING' : 'INFO'
                        }));
                        allLogs = allLogs.concat(serviceLogs);
                    } catch (e) { console.log('Service logs not available'); }
                }

                if (filter === 'all' || filter === 'resource') {
                    try {
                        const resourceResponse = await apiCall('/api/system-resources/logs');
                        const resourceLogs = (resourceResponse.logs || []).map(log => ({
                            ...log,
                            source: 'resource',
                            message: log.message || `${log.resource_type}: ${log.value_percent}%`,
                            level: log.status === 'exceeded' ? 'ERROR' : 'INFO'
                        }));
                        allLogs = allLogs.concat(resourceLogs);
                    } catch (e) { console.log('Resource logs not available'); }
                }

                // Sort by timestamp (newest first)
                allLogs.sort((a, b) => {
                    const dateA = new Date(a.timestamp || 0);
                    const dateB = new Date(b.timestamp || 0);
                    return dateB - dateA;
                });

                // Limit to 100 entries
                allLogs = allLogs.slice(0, 100);

                displayLogs(allLogs);
            } catch (error) {
                console.error('Failed to refresh logs:', error);
                showAlert('error', 'Failed to refresh logs');
            }
        }

        function displayLogs(logs) {
            const container = document.getElementById('logsContainer');

            if (logs.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 20px;">No logs available</div>';
                return;
            }

            container.innerHTML = '';

            logs.forEach(log => {
                const logDiv = document.createElement('div');
                logDiv.style.marginBottom = '8px';
                logDiv.style.padding = '8px';
                logDiv.style.borderRadius = '4px';
                logDiv.style.backgroundColor = log.level === 'ERROR' ? '#fee2e2' :
                    log.level === 'WARNING' ? '#fef3c7' : '#f0f9ff';

                const sourceLabel = log.source ?
                    `<span style="background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 8px;">${log.source.toUpperCase()}</span>` : '';

                logDiv.innerHTML = `
                    <span style="color: #64748b;">[${getTimeDelta(log.timestamp)}]</span>
                    ${sourceLabel}
                    <span style="color: ${log.level === 'ERROR' ? '#dc2626' : log.level === 'WARNING' ? '#d97706' : '#2563eb'}; font-weight: bold;">${log.level || 'INFO'}</span>
                    <span>${log.message || 'No message'}</span>
                `;

                container.appendChild(logDiv);
            });
        }

        // Global refresh function
        async function refreshAllData() {
            try {
                showAlert('success', 'Refreshing all data...');

                // Refresh all data in parallel
                await Promise.all([
                    refreshPortMonitors(),
                    refreshServiceMonitors(),
                    refreshResourceMonitoring(),
                    refreshLogs()
                ]);

                showAlert('success', 'All data refreshed successfully');
            } catch (error) {
                console.error('Failed to refresh all data:', error);
                showAlert('error', 'Failed to refresh some data');
            }
        }

        // WebSocket connection for real-time updates
        let ws = null;
        let wsReconnectInterval = null;
        let wsReconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function connectWebSocket() {
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/port-status`;

                ws = new WebSocket(wsUrl);

                ws.onopen = function () {
                    console.log('WebSocket connected');
                    wsReconnectAttempts = 0;
                    if (wsReconnectInterval) {
                        clearInterval(wsReconnectInterval);
                        wsReconnectInterval = null;
                    }
                };

                ws.onmessage = function (event) {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'port_status_update') {
                            // Update port monitors with real-time data
                            displayPortMonitors(data.data.ports);
                            updatePortStats(data.data.ports);
                        }
                    } catch (error) {
                        console.error('Failed to parse WebSocket message:', error);
                    }
                };

                ws.onclose = function () {
                    console.log('WebSocket disconnected');
                    if (wsReconnectAttempts < maxReconnectAttempts) {
                        wsReconnectAttempts++;
                        console.log(`Attempting to reconnect WebSocket (${wsReconnectAttempts}/${maxReconnectAttempts})`);
                        wsReconnectInterval = setTimeout(connectWebSocket, 5000);
                    }
                };

                ws.onerror = function (error) {
                    console.error('WebSocket error:', error);
                };

            } catch (error) {
                console.error('Failed to connect WebSocket:', error);
            }
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
            if (wsReconnectInterval) {
                clearInterval(wsReconnectInterval);
                wsReconnectInterval = null;
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            refreshPortMonitors();
            refreshServiceMonitors();
            refreshResourceMonitoring();
            refreshLogs();

            // Connect to WebSocket for real-time updates
            connectWebSocket();

            // Auto-refresh every 30 seconds (fallback if WebSocket fails)
            setInterval(() => {
                const activeTab = document.querySelector('.nav-tab.active').getAttribute('data-tab');
                switch (activeTab) {
                    case 'port-monitor':
                        // Only refresh if WebSocket is not connected
                        if (!ws || ws.readyState !== WebSocket.OPEN) {
                            refreshPortMonitors();
                        }
                        break;
                    case 'service-monitor':
                        refreshServiceMonitors();
                        break;
                    case 'resource-monitor':
                        refreshResourceMonitoring();
                        break;
                    case 'logs':
                        refreshLogs();
                        break;
                }
            }, 30000);
        });

        // Clean up WebSocket connection when page unloads
        window.addEventListener('beforeunload', () => {
            disconnectWebSocket();
        });

        // Log filter change
        document.getElementById('logFilter').addEventListener('change', refreshLogs);
    </script>
</body>

</html>